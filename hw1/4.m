I = imread("distlenna.pgm");
P0 = zeros(9,9,2);
P0(:,:,1) =...
  [  0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00];
P0(:,:,2) =...
  [  0.00   0.00   0.00   0.00   0.00   0.00   0.00   0.00   0.00;
    32.00  32.00  32.00  32.00  32.00  32.00  32.00  32.00  32.00;
    64.00  64.00  64.00  64.00  64.00  64.00  64.00  64.00  64.00;
    96.00  96.00  96.00  96.00  96.00  96.00  96.00  96.00  96.00;
   128.00 128.00 128.00 128.00 128.00 128.00 128.00 128.00 128.00;
   160.00 160.00 160.00 160.00 160.00 160.00 160.00 160.00 160.00;
   192.00 192.00 192.00 192.00 192.00 192.00 192.00 192.00 192.00;
   224.00 224.00 224.00 224.00 224.00 224.00 224.00 224.00 224.00;
   256.00 256.00 256.00 256.00 256.00 256.00 256.00 256.00 256.00];
P1 = zeros(9,9,2);
P1(:,:,1) =...
  [  0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00;
     0.00  32.00  66.67 104.65 136.63 163.94 192.59 224.00 256.00;
     0.00  34.70  80.67 117.31 144.62 167.27 191.26 223.90 256.00;
     0.00  41.36  86.00 118.64 141.96 161.28 185.26 218.57 256.00;
     0.00  42.69  83.33 109.98 129.97 149.29 176.66 213.91 256.00;
     0.00  37.43  70.74  94.72 114.04 137.36 170.00 214.64 256.00;
     0.00  32.10  64.74  88.73 111.38 138.69 175.33 221.30 256.00;
     0.00  32.00  63.41  92.06 119.37 151.35 189.33 224.00 256.00;
     0.00  32.00  64.00  96.00 128.00 160.00 192.00 224.00 256.00];
P1(:,:,2) =...
  [  0.00   0.00   0.00   0.00   0.00   0.00   0.00   0.00   0.00;
    32.00  32.00  32.00  32.00  32.00  32.00  32.00  32.00  32.00;
    64.00  64.21  65.55  71.54  79.54  84.27  80.20  66.21  64.00;
    96.00  92.86  89.53  94.86 108.08 117.51 116.28 104.85  96.00;
   128.00 119.51 111.51 114.84 127.50 140.83 144.16 136.16 128.00;                                            
   160.00 151.15 139.72 138.49 147.92 161.14 166.47 163.14 160.00;
   192.00 189.79 175.80 171.73 176.46 184.46 190.45 191.79 192.00;
   224.00 224.00 224.00 224.00 224.00 224.00 224.00 224.00 224.00;
   256.00 256.00 256.00 256.00 256.00 256.00 256.00 256.00 256.00];
subplot(1, 3, 1);
imshow(I);
J = uint8(zeros(size(I)(1), size(I)(2)));
for i = 1:(size(P0)(1)-1)
  for j = 1:(size(P0)(2)-1)
    x01 = P0(i,j,1);
    x02 = P0(i,j+1,1);
    x03 = P0(i+1,j+1,1);
    x04 = P0(i+1,j,1);
    x11 = P1(i,j,1);
    x12 = P1(i,j+1,1);
    x13 = P1(i+1,j+1,1);
    x14 = P1(i+1,j,1);
    y01 = P0(i,j,2);
    y02 = P0(i,j+1,2);
    y03 = P0(i+1,j+1,2);
    y04 = P0(i+1,j,2);
    y11 = P1(i,j,2);
    y12 = P1(i,j+1,2);
    y13 = P1(i+1,j+1,2);
    y14 = P1(i+1,j,2);
    P =...
      [-x01 -y01   -1    0    0    0 x01*x11 y01*x11 x11;
          0    0    0 -x01 -y01   -1 x01*y11 y01*y11 y11;
       -x02 -y02   -1    0    0    0 x02*x12 y02*x12 x12;
          0    0    0 -x02 -y02   -1 x02*y12 y02*y12 y12;
       -x03 -y03   -1    0    0    0 x03*x13 y03*x13 x13;
          0    0    0 -x03 -y03   -1 x03*y13 y03*y13 y13;
       -x04 -y04   -1    0    0    0 x04*x14 y04*x14 x14;
          0    0    0 -x04 -y04   -1 x04*y14 y04*y14 y14];
    H = null(P)';
    H = [H(1:3); H(4:6); H(7:9)];
    for k = 1:32
      for l = 1:32
        X = [x01 + l; y01 + k; 1];
        Y = H * X;
        Y ./= Y(3);
        x = Y(1);
        y = Y(2);
        _x = floor(x);
        _y = floor(y);
        if (_x < 1) _x = 1; end
        if (_y < 1) _y = 1; end
        x_ = _x+1;
        y_ = _y+1;
        if (x_ > 256) x_ = 256; end
        if (y_ > 256) y_ = 256; end
        dx = x - _x;
        dy = y - _y;
        f00 = I(_y,_x);
        f01 = I(_y,x_);
        f10 = I(y_,_x);
        f11 = I(y_,x_);
        a = f01 - f00;
        b = f10 - f00;
        c = f11 + f00 - f01 - f10;
        d = f00;
        f = a*dx + b*dy + c*dx*dy + d;
        J(y01+k, x01+l) = f;
      end
    end
  end
end
subplot(1,3,2);
imshow(J);
K = imread("Lenna.pgm");
subplot(1,3,3);
imshow(K);
fprintf("RMS error for Lenna is %6.2f\n", sqrt(sum(sum(imsubtract(K, J).^2))/prod(size(K))));